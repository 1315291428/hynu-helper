const rp = require('request-promise')
const cheerio = require('cheerio')

exports.getScore = async (data, url) => {
	const { sessionid, PageNum } = data
	console.log(data)

	const headers = {
		'content-type': 'application/x-www-form-urlencoded',
		Cookie: sessionid
	}

	const options = {
		method: 'POST',
		url: `${url}/xszqcjglAction.do?method=queryxscj`,
		headers,
		body: `Field1=a.xh&HH1=like&SValue1=&AndOr1=and&Field2=a.xh&HH2=like&SValue2=&where1=null&where2=null&OrderBy=${OrderBy}&keyCode=%23%21%40RnUFawQyEC0GYQV9VWVFKl83UGVDJVc4VT0QLg%3D%3D&isOutJoin=false&PageNum=${PageNum}&oldSelectRow=&printHQL=%23%21%40RjYFNARvEHIGYwUnVSZFIV8pUDFDf1cwVWMQegNmS3tRNhJqBmAFLBFvBzlXJFJ7SnNSflR6QnhX%0D%0Aegd1FipeKUY9BSARewdjBCsQJ1V1UHVdZEc9VnFVb0IgBXMBPUs8UzsSJQZsEHQGLAV7QnJSNl90%0D%0AUDdDNVd3VTwQLwMwXCVGJAd9EXUHahFxByJXJEV9XSVSd1RGQjJXdgcpFiNeYlE8EmYEdxB4Bl8Q%0D%0AJVVuUDRKYFB6VmFVLEI5BTwBNks7U3AFcRFzBW4RZAc0QjFSd19zR3BULFdkVT4QLAMtXGhGJgdz%0D%0ABiEQcgRsECJVL0VgXX9SM0N%2FVS5XfgcnFjFeY1ExEiwEYQdzETkFN0J8UjpKcVB7VmFCZlV0BTwB%0D%0ANktwUyMFPBF1BS4GKBAtV2dFOF1%2FR2tUZldtQi4HPgN3XGRGNgdzBmoQdAR6BytCfFA2Sj5QekN%2B%0D%0AVWFXOhAoAXJeY1E%2FEisEYAcpEXYFIFUmRStfZEcpVGBCeFU3BXMWKlwrUyoFKRFlBS4GYRBoV3xS%0D%0AMUo%2BUjtDZlV6QjkHcwM6S39RPwcwBi0QPwR6Bz9CaVAkXStHPVZxQnhVNxBjAT1edEZlBSkEcgcs%0D%0AEXYFfVVsRThfN1BmQyVXNEIqBzkWZ1xkU34SPgZyBTIGMRB2VzVSPkp2UnBUIkJzVyQQJQExSzJR%0D%0AMQc5ESYHNwQyB2lCMVA0XSVHKVZlVWRCNwV%2FFiFcakYsBT8EIxBtBnoFN1VtRTNff1AoQzVXa1Un%0D%0AEDIDJEsyUT0SKAYhBWkRZAcpV35SeUp2Uj1UP0J0V3gHNhY4Xn9GPwU4EXIHIARuECNVYFAhXSVH%0D%0AL1ZvVWtCLQV%2FASRLfFMoEjcGMRAmBiAFK0J%2FUi9fdlByQ3pXblV0EDIDMFx9RjQHfRFuB24Rbwcg%0D%0AVzRFcV1sUjRUP0J0V3gHPxYoXn9RIxJmBG8QcgZmEDJVJlA%2FSn1QO1ZuVSJCOQUlAThLeVMzBSkR%0D%0AbAUiEXwHMkJpUi1fJ0cqVGxXIFU%2FECkDJlx%2FRmsHNwZsECoEYxBoVW1FI119UipDNVVuVzMHOxY%2F%0D%0AXidROBIpBGoHbhE3BSlCa1IzSnlQMVZsQndVdAU0AT9LflMyBXEReQVsBiAQLVdnRSxdZ0drVGZX%0D%0AbUJ%2BBzwDcFxuRiYHPwZjEDcEbgc0QndQIUoyUDhDelVrVzgQagEmXn1RNhIlBGkHYhFkBXNVfEU6%0D%0AX2NHJlRoQndVJwV%2FFiRca1NwBSsRbAVmBmMQLFdmUiRKPFI0Q3hVP0IiB3MDPUt4UTAHIAYhEHsE%0D%0AZwc3QmVQdV1vRypWaUJ7VXQQMAEmXmNGIQU7BG4HYxE3BSdVM0VgX2hQPEM1V2FCbQceFgFcQ1MD%0D%0AEmYGPAUiBnQQc1cqUjRKeFI2VHFCeVcuEGoBPUt8UTYHcxE%2BB3QENwd%2FQnVQLF1jRzZWIFU%2FQmMF%0D%0APhZlXH9GJgU7BCMQeAZyBXNVckV1XylQMUN%2FV2ZVJxAmAyZLMlFvEmYGJgVGETAHeFckUndKZVI4%0D%0AVGdCZ1czB30Wel46RnQFcRF3B24EZhBmVWdQe119Ry1WPVUlQnIFaQFtSytTYBJ0BjIQJQYnBXNC%0D%0AcFI5X2NQckM1V2FVehAzAzJcf0YhB24RMQcxETAHcVdlRS5dYVJwVGNCO1c%2FBy4WL15iUT4SewQk%0D%0AECcGJw%3D%3D&sqlString=%23%21%40RjYFNARvEHIGYwUnVSZFIV8pUDFDf1cwVWMQegNmS3tRNhJqBmAFLBFvBzlXJFJ7SnNSflR6QnhX%0D%0Aegd1FipeKUY9BSARewdjBCsQJ1V1UHVdZEc9VnFVb0IgBXMBPUs8UzsSJQZsEHQGLAV7QnJSNl90%0D%0AUDdDNVd3VTwQLwMwXCVGJAd9EXUHahFxByJXJEV9XSVSd1RGQjJXdgcpFiNeYlE8EmYEdxB4Bl8Q%0D%0AJVVuUDRKYFB6VmFVLEI5BTwBNks7U3AFcRFzBW4RZAc0QjFSd19zR3BULFdkVT4QLAMtXGhGJgdz%0D%0ABiEQcgRsECJVL0VgXX9SM0N%2FVS5XfgcnFjFeY1ExEiwEYQdzETkFN0J8UjpKcVB7VmFCZlV0BTwB%0D%0ANktwUyMFPBF1BS4GKBAtV2dFOF1%2FR2tUZldtQi4HPgN3XGRGNgdzBmoQdAR6BytCfFA2Sj5QekN%2B%0D%0AVWFXOhAoAXJeY1E%2FEisEYAcpEXYFIFUmRStfZEcpVGBCeFU3BXMWKlwrUyoFKRFlBS4GYRBoV3xS%0D%0AMUo%2BUjtDZlV6QjkHcwM6S39RPwcwBi0QPwR6Bz9CaVAkXStHPVZxQnhVNxBjAT1edEZlBSkEcgcs%0D%0AEXYFfVVsRThfN1BmQyVXNEIqBzkWZ1xkU34SPgZyBTIGMRB2VzVSPkp2UnBUIkJzVyQQJQExSzJR%0D%0AMQc5ESYHNwQyB2lCMVA0XSVHKVZlVWRCNwV%2FFiFcakYsBT8EIxBtBnoFN1VtRTNff1AoQzVXa1Un%0D%0AEDIDJEsyUT0SKAYhBWkRZAcpV35SeUp2Uj1UP0J0V3gHNhY4Xn9GPwU4EXIHIARuECNVYFAhXSVH%0D%0AL1ZvVWtCLQV%2FASRLfFMoEjcGMRAmBiAFK0J%2FUi9fdlByQ3pXblV0EDIDMFx9RjQHfRFuB24Rbwcg%0D%0AVzRFcV1sUjRUP0J0V3gHPxYoXn9RIxJmBG8QcgZmEDJVJlA%2FSn1QO1ZuVSJCOQUlAThLeVMzBSkR%0D%0AbAUiEXwHMkJpUi1fJ0cqVGxXIFU%2FECkDJlx%2FRmsHNwZsECoEYxBoVW1FI119UipDNVVuVzMHOxY%2F%0D%0AXidROBIpBGoHbhE3BSlCa1IzSnlQMVZsQndVdAU0AT9LflMyBXEReQVsBiAQLVdnRSxdZ0drVGZX%0D%0AbUJ%2BBzwDcFxuRiYHPwZjEDcEbgc0QndQIUoyUDhDelVrVzgQagEmXn1RNhIlBGkHYhFkBXNVfEU6%0D%0AX2NHJlRoQndVJwV%2FFiRca1NwBSsRbAVmBmMQLFdmUiRKPFI0Q3hVP0IiB3MDPUt4UTAHIAYhEHsE%0D%0AZwc3QmVQdV1vRypWaUJ7VXQQMAEmXmNGIQU7BG4HYxE3BSdVM0VgX2hQPEM1V2FCbQceFgFcQ1MD%0D%0AEmYGPAUiBnQQc1cqUjRKeFI2VHFCeVcuEGoBPUt8UTYHcxE%2BB3QENwd%2FQnVQLF1jRzZWIFU%2FQmMF%0D%0APhZlXH9GJgU7BCMQeAZyBXNVckV1XylQMUN%2FV2ZVJxAmAyZLMlFvEmYGJgVGETAHeFckUndKZVI4%0D%0AVGdCZ1czB30Wel46RnQFcRF3B24EZhBmVWdQe119Ry1WPVUlQnIFaQFtSytTYBJ0BjIQJQYnBXNC%0D%0AcFI5X2NQckM1V2FVehAzAzJcf0YhB24RMQcxETAHcVdlRS5dYVJwVGNCO1c%2FBy4WL15iUT4SewQk%0D%0AECcGJw%3D%3D&isSql=true&beanName=&printPageSize=10&key=%23%21%40RnUFawQyEC0GYQV9VWVFKl83UGVDJVc4VT0QLg%3D%3D&field=%23%21%40RpQF9gS5ENIGOgViVTxFcV89UGtDJVc6VTUQZAMmS3pRfhKWBtQFwRHsB2tXNlJtSiNSalQzQiRX%0D%0AZgdnFipeKUY9BTwROge%2FBKgQ%2BVXIUIRdokeDVtpVOEJwBWUBbUsoU2ESdAYxEC0GYQV9QmlSJl9q%0D%0AUDFDOVe%2FVZoQ%2BQOSXMZGvgfgEdAHOhEjB2tXNUV6XTRSY1QyQi9XNwdzFiBeZFE%2FEiUELxDABtwQ%0D%0A9VXPUOlKulBoVjVVOEJyBWUBa0siU2oFMBE4BXgRdAc7Qj1S5F%2FOR%2FlUqlexVb4QnAPgXD9Gcwdp%0D%0ABjAQLQQ7EHZVPEVsXbpSnkOmVc5XhgeJFp1ezVFoEnEEOQcxES0FYkIgUmdKKFB%2BVr9C21XnBZMB%0D%0AnEvyU%2BEFoREsBToGOhB3Vz5FeV01R39ULlfRQuQHlwPvXD9GfAdpBjAQLQQ1B2FCK1A0SjxQKENt%0D%0AVXFXehCbAftesFGEEnwEMgcwES0FYlU8RXdfN0d%2FVGNCO1UsBTkWZ1y6U%2BwFmxHCBdIG1BCQV85S%0D%0AbUojUmFDL1UzQnkHbANuSyJRaAc4BnIQbwR4B39CdVA4XWhHJlYsQqdV7RCcAYRe1kbiBZcE2Qc6%0D%0AESYFYVU8RXFfPVBjQyVXMEJ5&totalPages=7&ZdSzCode=&ZdSzCodeValue=&ZdSzValueTemp=&ZDSXkeydm=&PlAction=&tableFields=%E5%AD%A6%E5%8F%B7%3A1%3A1%3A90%3Aa.xh%2C%E5%A7%93%E5%90%8D%3A2%3A1%3A110%3Aa.xm%2C%E5%BC%80%E8%AF%BE%E5%AD%A6%E6%9C%9F%3A3%3A1%3A120%3Aa.xqmc%2C%E8%AF%BE%E7%A8%8B%E5%90%8D%E7%A7%B0%3A4%3A1%3A130%3Aa.kcmc%2C%E6%80%BB%E6%88%90%E7%BB%A9%3A5%3A1%3A70%3Aa.zcj%2C%E6%88%90%E7%BB%A9%E6%A0%87%E5%BF%97%3A6%3A1%3A90%3A%2C%E8%AF%BE%E7%A8%8B%E6%80%A7%E8%B4%A8%3A7%3A1%3A110%3A%2C%E8%AF%BE%E7%A8%8B%E7%B1%BB%E5%88%AB%3A8%3A1%3A90%3A%2C%E5%AD%A6%E6%97%B6%3A9%3A1%3A70%3Aa.zxs%2C%E5%AD%A6%E5%88%86%3A10%3A1%3A70%3Aa.xf%2C%E8%80%83%E8%AF%95%E6%80%A7%E8%B4%A8%3A11%3A1%3A100%3Aksxz.dmmc%2C%E8%A1%A5%E9%87%8D%E5%AD%A6%E6%9C%9F%3A12%3A1%3A100%3A&otherFields=null`
	}

	return rp(options)
		.then(body => {
			let msg
			const end = body.indexOf('</table>', 7474) + 8
			const $ = cheerio.load(body.slice(7474, end))
			const score_arr = []
			$('#mxh tr').each((i, value) => {
				const getTxt = num =>
					$(value)
						.children()
						.eq(num)
						.text()

				score_arr.push({
					term: getTxt(3),
					course: getTxt(4),
					score: getTxt(5),
					sort: getTxt(7),
					hour: getTxt(9),
					credit: getTxt(10),
					makeup: getTxt(11) == '正常考试' ? false : true
				})
			})

			const start = body.indexOf('"1/', -1) + 3
			const page_end = body.indexOf('\\', start)
			if (!score_arr.length) {
				msg = '没有更多数据'
			}
			const pageNums = body.slice(start, page_end)
			return (res = {
				code: 200,
				msg,
				score: {
					score_arr,
					pageNums
				}
			})
		})
		.catch(err => {
			console.log('网络错误', err)
			return (res = '网络错误或其他异常')
		})
}
